#include "AccessibilityAnalysisTool.h"
#include "GeoMap.h"
#include <qsqlquery.h>


AccessibilityAnalysisTool::AccessibilityAnalysisTool() {

	dijkstraSql = "select sum(cost) from :arcTableName where gid in (SELECT id2 AS edge FROM pgr_dijkstra('\
		SELECT gid AS id,\
		fnode_ as source,\
		tnode_ as target,\
		length::double precision AS cost,\
		cost_vert ::double precision AS reverse_cost\
		FROM :arcTableName',\
		:start_index, :end_index, false, false))";
	//静态测试
	/*dijkstraSql = "select sum(cost) from arc where gid in (SELECT id2 AS edge FROM pgr_dijkstra('\
		SELECT gid AS id,\
		fnode_ as source,\
		tnode_ as target,\
		length::double precision AS cost,\
		cost_vert ::double precision AS reverse_cost\
		FROM arc',\
		:start_index, :end_index, false, false))";*/
}


AccessibilityAnalysisTool::~AccessibilityAnalysisTool()
{
}

//当此函数被执行时，所有参数已经检验过正确性
GeoLayer * AccessibilityAnalysisTool::run_tool()
{
	GeoLayer* layer = NULL;
	if (option) {
		//连接数据库
		db = QSqlDatabase::addDatabase("QPSQL");
		db.setUserName("postgres");
		db.setPassword("zhang002508");
		db.setHostName("127.0.0.1");
		db.setPort(5432);
		db.setDatabaseName("postgis_25_sample");
		db.open();

		if (option->getToolType() == EnumType::ACCESSIBILITY_ANALYSIS) {
			AccessibilityOption* option = (AccessibilityOption*)this->option;
			GeoLayer* oriPointLayer = option->getOriginPointLayer();
			GeoLayer* dirPointLayer = option->getDirPointLayer();
			GeoLayer* arcLayer = option->getArcLayer();
			GeoLayer* nodeLayer = option->getNodeLayer();
			float limitTine = option->getTimeLimit();
			QString saveFieldName = option->getSaveField();
			
			QString arcTableName = arcLayer->getName();
			QString nodeLayerName = nodeLayer->getName();

			QList<GeoFeature*> features = option->getUseSelectedFeatures()?
				option->getOriginPointLayer()->getSelectedFeatures():option->getOriginPointLayer()->getAllFeature();

			for (int i = 0; i < features.size(); i++) {
				GeoFeature* oriPointFeature = features.at(i);
				GeoPoint* oriPoint = (GeoPoint*)oriPointFeature->getGeometry();
				GeoFeature* roadOriNodeFeature = nodeLayer->identify(oriPoint, 9999999999999);
				float accessibilityValue = 0;
				int ori_index = (*(roadOriNodeFeature->getAttributeMap()))["road_featu"].toInt();
				for (int j = 0; j < dirPointLayer->size(); j++) {
					GeoPoint* dirPoint = (GeoPoint*)dirPointLayer->getFeatureAt(j)->getGeometry();
					GeoFeature* roadDirNodeFeature = nodeLayer->identify(dirPoint, 9999999999999);
					int dir_index = (*(roadDirNodeFeature->getAttributeMap()))["road_featu"].toInt();
					/*QSqlQuery query;
					query.prepare(dijkstraSql);
					//query.bindValue(":arcTableName", arcTableName);
					query.bindValue(":start_index", ori_index);
					query.bindValue(":end_index", dir_index);
					query.exec();
					while (query.next()) {
						float cost = query.value(0).toFloat();  //查询距离成本
						if (cost) {
							accessibilityValue += 1.0 / cost;  //计算点的可达性之和
						}
					}*/ //速度过慢暂时不用
					GeoPoint* dirP = (GeoPoint*)roadDirNodeFeature->getGeometry();
					float dis = oriPoint->disToPoint(dirP);
					if (dis > 0) {
						accessibilityValue += 1.0 / dis;
					}
				}
				QMap<QString, QVariant>* map = oriPointFeature->getAttributeMap();
				map->insert(saveFieldName, accessibilityValue);
			}
			//添加数据到ori图层中
			QList<QString> names = oriPointLayer->getAttributeNames();
			names.push_back(saveFieldName);
			oriPointLayer->setAttributeNames(names);
		}
	}
	return layer;
}
